---
layout: post
title:  "Effect of data transformation on linear dimensionality reduction"
author: Xinyue Gu
jhed: xgu18
categories: [ HW2 ]
image: homework/hw1/hw1_xgu18.png
featured: false
---

## What data types are you visualizing?

In general, I am visualizing the quantitative data of the expression of CD68 gene undergoing through different data transformation. The gene is randomly picked for demonstration purposes.

(1) on the first column, I am visualizing the quantitative data of the eigenvalues of each pC (i.e., the amount of variance they explain in the current PCA gene expression) against quantitative (ordinal) data of the PC number (as PCs are automatically ranked by the signifiance).

I also plotted the quantitative data of the first PC with an eigenvalue smaller than 1. 

(2) on the second column, I am visualizing the quantitative data of the cumulative sum of proportion of total variance explained against the quantitative (ordinal) data  of the PC number. I also plotted the quantitative data of the total variance explained by top 100 PCs and the value of the sum. 

(3) on the third column, I am visualizing the quantitative data of CD68 expression against the first two PCs (the most significant one) in the current experiment. 

For each row, I am conducting a different experiment: 
the first row - the data is in its original form.
the second row - the data undergo scaling (so that each gene expression has a variance of 1)
the third row - the data undergo log transformation (so that they appear more Gaussian-like) 
the fourth row - the data undergo first log and then scaling trnasformation 


## What data encodings are you using to visualize these data types?

In the first column, I am using the geometric primitive of points to visualize each principal component, and the geometric primitive of line to visualize the descending variance explained by each PC. I am using the geometric primitive of dot, visual channel of color, and associated text description to visualize the first PC in each experiment with an eigenvalue smaller than 1. A side note is that to make the meaning of the colored dot clear, I am using the adding a text description along the x axis.


In the second column, I am using the geometric primitive of dots to visualiz each PC and a not visible line to visualize the ascending trend of the cumulative proportion of total variance explained. I am using the geometric primitive of line, visual channel of color, and associated text to visualize the total variance explained.

In both the first and the second column, to visualize the sorted order of PCs, I am using the visual channel of positions along the x axis. To visualize the amount of variance explained or the cumulative sum of total variance explaied, I am using the visual channel of positions along the y axis. 

In the third column, I am using the geometric primitive of dots to visualize each individual cell, and the visual channel of saturation to visualize the amount of gene expresion.`lightgrey` color refers to non expression whereas full saturation refers to maximum expression. To encode the distribution of the cells along the two PCs, I am using the visual channel of positions along the x and y axis.


## What type of data visualization is this? What about the data are you trying to make salient through this data visualization? 

This is an exploratory data visualization. I am trying to make salient the impact of different data transformation methods and their effects on PCA analysis (both on the total amount of variance explained by the top 100 PCs and the number of the first PC with an eigenvalue smaller than 1) The first PC with an eigen value smaller than 1 is per the elbow rule, the critical index indicating how many PCs the user should keep in PCA (https://en.wikipedia.org/wiki/Elbow_method_(clustering)). Especially, I hope to make more salient the effect on the PCA visualization of the CD68 gene expression downstream. 


## What Gestalt principles or knowledge about perceptiveness of visual encodings are you using to accomplish this?

I am using the gestalt principle of proximity by grouping a same batch of experiment along the same row, and a same topic of data visualization along the same column. In addition, to make more salient which graphs belong to the same experiment, I am using the gestalt principle of similarity by using a same hue / saturation. To make more salient the trend in the PCs (in terms of decreasing variance explained, especially), I am using the gestalt principle of continuity by linking the dots representing each PC together. 

## Additional comments 

1. Note: after doing log and scale transformation separately using `log_scale_gexp <- log10(scaled_gexp+1)`, I received an error message saying NaN is generated. After inspecting the dataframe using `which(is.na(log_scale_gexp), arr.ind=TRUE)` (reference:https://stackoverflow.com/questions/19895596/locate-index-of-rows-in-a-dataframe-that-have-the-value-of-na), I located that only column #230, the gene "POLR2J3" causes the issue, though I do not know how to interpret this result. However, when I did it the other way using `log_scale_gexp <- scale(logged_gexp+1)`, I did not receive the error message. I hence proceed with the latter implementation. 

2. I struggle to find a nice visualization without compromising many details. Should be more fun to see what the results would look like on tSNE.

3. It seems weird that the PC applied on raw data is in reverse direction compared to data undergoing transformations. 


## Code

```{r}
Reference:
Thanks to classmates for some ideas:)

drop all columns whose values sum to 0: https://stat.ethz.ch/pipermail/r-help/2007-April/130646.html 

get the most highly expressed gene name:
https://stackoverflow.com/questions/20679702/r-find-column-with-the-largest-column-sum

figure out how to concatenate strings:
https://www.geeksforgeeks.org/string-concatenation-in-r-programming/

figure out how to access the names in a ~soft way:
https://stackoverflow.com/questions/67128776/cannot-access-column-when-using-for-loop-in-r

figure out how to arrange plots:
http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.height = 4, fig.width = 5.5)

library(ggplot2)
library(gridExtra)
library(dplyr)

data <- read.csv("~/Desktop/GitHub_Repo/genomic-data-visualization-notes/project/bulbasaur.csv",row.names = 1)

# screen valid entries only 
gexp <- data[,5:ncol(data)]
data <- data[(rowSums(gexp)>0),]
data$mean <- rowSums(gexp)
meanCount <- mean(data$mean)

# normalize
data[,5:ncol(data)] <- data[,5:ncol(data)] / meanCount 

# drop col sums 0 (genes not expressed in any samples)
data <- data[, which(colSums(data) != 0)] 

# get the names of the most higly expressed genes 

highest_genes <- names(sort(colSums(gexp[,2:length(gexp)]), decreasing = TRUE)[1:3])




```{r plotting}

p1 <- ggplot(data = data) + geom_point(aes (x = x_centroid, y = y_centroid, col = 100*data[[highest_genes[1]]]/mean, size = area/10)) + 
    scale_colour_gradient(low ='lightgrey',high='blue',name = "% of exp in the cell" )+ 
    theme_light() + 
    ggtitle(paste("normalized expression of",highest_genes[1],"gene in each cell", sep = " "))

p2 <- ggplot(data = data) + geom_point(aes (x = x_centroid, y = y_centroid, col = 100*data[[highest_genes[2]]]/mean, size = area/10)) + 
    scale_colour_gradient(low ='lightgrey',high='red',name = "% of exp in the cell" )+ 
    theme_light() + 
    ggtitle(paste("normalized expression of",highest_genes[2],"gene in each cell", sep = " "))

p3 <- ggplot(data = data) + geom_point(aes (x = x_centroid, y = y_centroid, col = 100*data[[highest_genes[3]]]/mean, size = area/10)) + 
    scale_colour_gradient(low ='lightgrey',high='green',name = "% of exp in the cell" )+ 
    theme_light() + 
    ggtitle(paste("normalized expression of",highest_genes[3],"gene in each cell", sep = " "))

p4 <- ggplot(data = data) + geom_point(aes (x = x_centroid, y = y_centroid, col = 100*(data[[highest_genes[3]]] +data[[highest_genes[2]]] + data[[highest_genes[1]]]) /mean, size = area/10)) + 
    scale_colour_gradient(low ='lightgrey',high='yellow',name = "% of exp in the cell" )+ 
    theme_light() + 
    ggtitle(paste("normalized expression of all 3 most significant genes in eah cell", sep = " "))



grid.arrange(p4, p3,p2,p1, nrow =2)

```


